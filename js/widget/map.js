define("SensorWidget",["i18n","css!SensorWidgets.css"],function(e){"use strict";var t={},n=function(e){return function(){return"SensorWidgetTarget-"+ ++e}}(0);return function(i,r,o){function a(e,t,n){var i="";t&&(i="["+t+"] "),n&&n.request&&(i+=n.request+": "),e&&(i+=e),o.innerHTML='<div class="text-danger">'+i+"</div>"}function s(t,n,i){var r=[];for(var o in n){var s=n[o];i.hasOwnProperty(s)||r.push(s)}return r.length&&a(e.t("The '{name}' widget is missing some mandatory parameters: ",{name:t})+r.join(", ")),!r.length}return o||(o=document.body),i&&r?(o.id||(o.id=n()),r.service||(r.service="/52n-sos/sos/json"),require(["widget/"+i],function(e){o.innerHTML="",t.hasOwnProperty(o.id)&&t[o.id]&&t[o.id].hasOwnProperty("destroy")&&(console.debug("Destroying previous widget on ElementId="+o.id),t[o.id].destroy(),delete t[o.id]),s(i,e.inputs,r)&&(console.debug("Creating new "+i+" widget on ElementId="+o.id),t[o.id]=e.init(r,o,a))},function(){a(e.t("Widget '{name}' cannot be found",{name:i}))})):i||a(e.t("No widget name specified")),{name:i,config:r,renderTo:o,inspect:function(e){require(["widget/"+i],function(t){e.call(this,t.inputs,t.optional_inputs,t.preferredSizes)})},url:function(){function t(e){var t=[];return e.replace(/^(\.\.?(\/|$))+/,"").replace(/\/(\.(\/|$))+/g,"/").replace(/\/\.\.$/,"/../").replace(/\/?[^\/]*/g,function(e){"/.."===e?t.pop():t.push(e)}),t.join("").replace(/^\//,"/"===e.charAt(0)?"/":"")}var n=t(require.toUrl("../widget/"))+"?";return n+="name="+encodeURIComponent(i)+"&",n+=Object.keys(r).map(function(e){var t=r[e];return"object"==typeof r[e]&&(t=JSON.stringify(r[e])),e+"="+encodeURIComponent(t)}).join("&"),n+="&lang="+e.getLang()},iframe:function(e,t){return e=e?e:"100%",t=t?t:"100%",'<iframe src="'+this.url()+'" width="'+e+'" height="'+t+'" frameBorder="0"></iframe>'},javascript:function(){return"SensorWidget('"+i+"', "+JSON.stringify(r,null,3)+", document.getElementById('"+i+"-container'));"}}}}),define("widget/map",["i18n","SOS","leaflet","SensorWidget","widget-common","leaflet-label","leaflet-cluster"],function(e,t,n,i,r){"use strict";return n.Label.prototype._updateContent=function(){if(this._content&&this._map&&this._prevContent!==this._content){if("string"==typeof this._content)this._container.innerHTML=this._content;else{for(;this._container.hasChildNodes();)this._container.removeChild(this._container.firstChild);this._container.appendChild(this._content)}this._prevContent=this._content,this._labelWidth=this._container.offsetWidth}},{inputs:r.inputs.concat(["features","properties"]),optional_inputs:["permanent_tooltips","popup_widget","no_clustering","swap_axis","max_initial_zoom","base_layer"].concat(r.optional_inputs),preferredSizes:[{w:550,h:400}],init:function(o,a,s){function p(){t.getCapabilities(function(e){function r(e){a.innerHTML="";var t=document.createElement("div");t.className="map widget",a.appendChild(t);var r,s=n.map(t,{layers:[l]}).setView([0,0],2);o.no_clustering?r=s:(r=n.markerClusterGroup({showCoverageOnHover:!1,maxClusterRadius:50}),s.addLayer(r));var p=n.geoJson(f(e),{onEachFeature:function(e,t){o.on_click&&t.on("click",function(e){o.on_click(e.target)});var n=document.createElement("div");if(n.id="map-tooltip-"+e.id,n.appendChild(document.createTextNode(e.properties.name)),t.bindLabel(n,{noHide:!0}).addTo(r),o.properties&&"[]"!=o.properties&&o.properties.length&&new i("panel",{service:o.service,offering:o.offering,feature:e.id,properties:o.properties,refresh_interval:"60",title:e.properties.name},n),!o.permanent_tooltips&&t.setLabelNoHide&&t.setLabelNoHide(!1),o.popup_widget){var a=document.createElement("div"),s=JSON.parse(JSON.stringify(o.popup_widget)),p=s.name;delete s.name,s.service=o.service,s.offering=o.offering,new i(p).inspect(function(n,r,o){-1!=n.indexOf("feature")?s.feature=e.id:-1!=n.indexOf("features")&&(s.features=[e.id]),t.bindPopup(a,{minWidth:o[0].w,minHeight:o[0].h}),a.setAttribute("style","width:"+o[0].w+"px;height:"+o[0].h+"px;"),new i(p,s,a)})}}});s.fitBounds(p.getBounds(),{maxZoom:o.max_initial_zoom?parseInt(o.max_initial_zoom):14})}for(var p in e){var u=e[p];u.identifier==o.offering&&t.getFeatureOfInterest(u.procedure[0],r,s)}},s)}function u(e){return"[object Array]"===Object.prototype.toString.call(e)}function c(e,t){return t.indexOf(e)>-1}function d(e){for(var t=[],n=0;n<e.length;n++)u(e[n])?t[n]=d(e[n]):!n%2&&(t[n]=e[n+1],t[n+1]=e[n]);return t}function f(e){var t=u(o.features)?o.features:JSON.parse(o.features),n=[];for(var i in e){var r=e[i];if(r.geometry&&(!t.length||c(r.identifier.value,o.features))){o.swap_axis||(r.geometry.coordinates=d(r.geometry.coordinates));var a={type:"Feature",geometry:r.geometry,id:r.identifier.value,properties:{name:r.name?r.name.value:r.identifier.value}};n.push(a)}}var s={type:"FeatureCollection",features:n};return s}a.innerHTML=e.t("Loading..."),r.init(o,a);var l;if(o.base_layer){var g="string"==typeof o.base_layer||o.base_layer instanceof String?JSON.parse(o.base_layer):o.base_layer;l=g.type&&"WMS"===g.type.toUpperCase()?n.tileLayer.wms(g.url,g.options):n.tileLayer(g.url,g.options)}else l=n.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19});o.footnote&&(l.options.attribution+=" | <b>"+o.footnote+"</b>"),("string"==typeof o.popup_widget||o.popup_widget instanceof String)&&(o.popup_widget=JSON.parse(o.popup_widget)),t.setUrl(o.service),p()}}});